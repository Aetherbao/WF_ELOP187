/*************************************************************************
软件新 版本   ：01_Platform_SensorBased_LIN_9879_120W_V1_1
软件旧 版本   ：01Platform_SensorBased_LIN_9879_120W_V1.0
软件修改日期 ：2024.07.30
修改人          ： 徐金帅
**************************************************************************/
功能新增：

软件bug/需求：
1. 模型变更（袁晓强）
2.ADC2模块的VCP电压下限阈值由需修改为15V。
3.BDRV模块中VCP低电压阈值由7.325V修改为9.62V。
4.将中断函数中VS上限与下限出现故障后，直接清故障位逻辑删除，VS超上限、VSD超上限、VCP超上限故障位置位后，在1秒的时间片内清除。
5.修改PLL故障发生后的故障反应。
6.增加TLE5012B故障诊断功能，通过读取TLE5012B的 Safety Word判断位置传感器是否存在故障，在PCBA上使用磁铁进行测试。
7.在软件中增加底层故障监控。


bug修复/功能新增：
1.模型优化PI模块，使其永远不会溢出，同时更改相电压限制值，确保电流采样合理且正确。
2.通过config wizard 模块修改ADC2模块的VCP电压下限阈值为15V。
3.通过config wizard 模块修改BDRV模块的VCP电压下限阈值为9.62V。
4.将中断函数中VS上限与下限出现故障后，直接清故障位逻辑删除，在1秒的时间片对VS超上限、VSD超上限、VCP超上限故障位置位后，清除该故障。
5.PLL故障发生后，首先清PLL故障位，再使用while(1)函数复位程序。
6.增加TLE5012B故障诊断功能，在500us中断中，读取safety word的值，当safety word的高8位不为0XFD，连续8次，判断有故障，故障恢复同样需要8次，故障发生后，Err_stTLE5012BSensor值1.
7.故障监控的变化周期为1秒，故障的bit位如下：
bit0  Gu8_DIAG_VDD_1V5OV           1.5V过压故障
bit1  Gu8_DIAG_PMU_1V5OverLoad  1.5V过载
bit2  Gu8_DIAG_VDD_5VOV              5V过压
bit3  Gu8_DIAG_PMU_5VOverLoad     5V过载
bit4  Su8_DIAG_VCPLOWTH1Fault    VCP低压阈值1故障
bit5  Su8_DIAG_VCPLOWTH2Fault    VCP低压阈值2故障
bit6  Su8_DIAG_HSLS_OCStatus  HSLS 过流故障
bit7
bit8  Gu8_DIAG_PLLLossLock         PLL故障
bit9  
bit10 Gu8_DIAG_PSCDFault            TLE5012B故障

/*************************************************************************
软件新 版本   ：01_Platform_SensorBased_LIN_9879_120W_V1_2
软件旧 版本   ：01Platform_SensorBased_ LIN_9879_120W_V1 1
软件修改日期 ：2024.08.05
修改人          ： 徐金帅
**************************************************************************/
功能新增：
软件bug/需求：
1. BDRV的诊断使用中断的方式进行采集，会造成在故障状态下，TLE9879频繁的中断，打断时间片的运行。

bug修复/功能新增：
1. BDRV的诊断使用轮询的方式对故障进行诊断。

/*************************************************************************
软件新 版本   ：01_Platform_SensorBased_LIN_9879_120W_V1_3
软件旧 版本   ：01Platform_SensorBased_ LIN_9879_120W_V1 2
软件修改日期 ：2024.08.09
修改人          ： 徐金帅
**************************************************************************/
功能新增：
软件bug/需求：
1. 张海清与袁晓强对LIN协议进行了调整。
2.袁晓强对模型进行了调整,解决系统状态机变更后的逻辑判断。
3.根据2024年8月6号故障诊断的讨论结果，对底层诊断逻辑进行了修改，
底层输入给应用层的故障诊断Err_stBSWToAPPFault_mp bit位对应关系如下：
bit0 5V供电 过压故障
bit1 5V供电 过载故障
bit2 预驱电源 过压故障
bit3 预驱电源 欠压故障
bit4 硬件过流故障 
bit5 位置传感器故障
4. 增加底层对应故障项的应用层模型方案；
5. 增加冷启动的扭矩限值和过流保护选项和方案。

/*************************************************************************
软件新 版本   ：01_Platform_SensorBased_LIN_9879_120W_V1_4
软件旧 版本   ：01Platform_SensorBased_ LIN_9879_120W_V1 3
软件修改日期 ：2024.08.30
修改人          ： 袁晓强
**************************************************************************/
1.应用层增加混合平台，可实现有感、无感切换
2.优化睡眠逻辑，修复冷启动过流保护阈值实现
3.更改吉利报文，完成测试


/*************************************************************************
软件新 版本   ：01_Platform_Hybrid_LIN_120W_1021_SensorForHUAWEI_sailisi1021
软件旧 版本   ：01_Platform_SensorBased_LIN_9879_120W_V1_4
软件修改日期 ：2024.10.23
修改人          ： 陆云祺
**************************************************************************/
1.通信协议按照赛力斯的通信协议
2.有感程序，跛行2500rpm，限额20A，LIN烧写LIN控制，用于塞力斯交样120W泵，主要修改为通信显示。转速小于500转全部用500转控制。

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.0
软件旧 版本   ：ELOP187_GEELY_9879_120W_V1.0
软件修改日期 ：2025.02.17
修改人          ： 袁晓强
**************************************************************************/
1.MID_Interface：修改过流保护循环确诊，并且在接口层通讯上报中间环节不上报；
2.干转故障的后处理逻辑修改为报故障不停机，干转故障通过EOP_RunningStatus置6表示。

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.1
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.0
软件修改日期 ：2025.02.19
修改人          ： 袁晓强
**************************************************************************/
1.更改中断优先级，将500us定时器中断优先级调高相较于通讯中断；
2.修改MID_Interface组件转速输出处理功能，确保用于打包发送的转速不会溢出且不会小于0；
3.修改MID_Interface组件转速输出处理功能，考虑客户特殊要求，将转速进行相应逻辑处理后输出；
4.修改MID_Interface组件目标转速输入解析功能，考虑客户特殊要求，将目标转速进行相应逻辑处理；
5.修改MID_Interface组件转速输出处理功能，用AST组件输出的转速替代PhVltgGen组件输出的转速，目的是让客户看到的转速更好；
6.新增内部故障（包括芯片5V过载、芯片5V过压、电机三相缺相），通过EOP_GmrSpiCommErr报出。位置传感器故障通过EOP_OffseVoltageFailure报出；
7.堵转故障中间过程LIN故障位不置位

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.2
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.1
软件修改日期 ：2025.02.20
修改人          ： 袁晓强
**************************************************************************/
1.更新通讯层软件；
2.更新CRC算法的实参，将计数长度由6改成7；
3.更新硬件版本后和软件版本号，用于UDS发送；
4.应用报文增加供应商ID，硬件版本号，软件版本号；
5.增加硬件过流故障底层输入MID_Interface的次数Su8_DIAG_HSLS_OCWarning，并将其引入到过硬件电流通讯上报；
6.将实际机械转速修改为全局变量，并在MID_Interface.h文件增加Extern，用于底层调用；

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.3
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.2
软件修改日期 ：2025.03.04
修改人          ： 陆云祺
**************************************************************************/
1.接口层相电流通讯发送左移8位改成右移7位；
2.源代码中PI参数无法在有负载的情况下全功率运行，重新标定转速环以及电流环的PI参数；
3.相电流增益系数修改为52428；
4.转速上升斜率修改为800；
5.母线电流MAP重新标定；
6.修改电压相位延时const sint16 Gs16_tCtlVltgDelTi_C = 0，const sint16 Gs16_tiPhVltgAgDel_C =-400；
7.修改地址是10000，用于调试器调试；
8.将软件版本号改为ELOP187SP001.03.
/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.4
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.3
软件修改日期 ：2025.03.05
修改人          ： 林成嘉
**************************************************************************/
1.修改图形配置工具的配置文件，使得工具中的参数与代码保持一致；代码中.h文件中有微调但实际并未使用，只是为了保证配置文件和代码的一致性；
2.同步徐金帅的变更
    内部的VDD1.5V和5V过压，进行retry确认后上报，原来的过载从上报改为直接看门狗复位，不再上报
    内部的Vref5V诊断其过压低压和过载，如果发生就看门狗复位
3.变量名称修改Su8_DIAG_HSLS_OCWarning改为Gu8_DIAG_HSLS_OCWarning。该变量原来为内部的，但是目前需要传递给外部组件，需要改为全局变量；

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.5
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.4
软件修改日期 ：2025.03.17
修改人          ： 林成嘉
**************************************************************************/
1、建立BDRV的状态机，在OBD传递需要关管状态时，判断如果处于开管状态，则关闭BDRV输出。此时不再关闭CCU6的T12时钟；
    如果OBD没有处于关管状态，但是底层判断到BDRV处于关管状态，则开管；
    删除函数PWM_CalcStart中的开关管标志位‘Gu8_PWM_MotorRunStatus=1’逻辑，无意义的逻辑耦合，该标志位全部由BDRV管理，因此名字改为Su8_PWM_MotorRunStatus
    ——空载故障停机方式为减速停机，占空比都为0
    ——26V电压(过压)下应该关管状态下的意外转动
2、VCP欠压诊断时间30ms，按客户要求改为50ms，函数DIAG_VCPFault_Handle从10ms定时任务改为100ms定时任务；——吉利客户要求
3、过流诊断处理方式修改，DIAG_HSLS_OC_Timer_Handle_ISR取消，不再需要管理Timer21的执行周期和Task_StartupTask的执行，相关逻辑
    放在函数DIAG_HSLS_OC_Handle中，第2次尝试的延时依然是4s
4、为了使用IMG脚本工具，需要固定可读写的DID地址，详细划分了3个可续写的产品信息的ram地址，使得1个分区内只有1个变量，不再会因为代码逻辑变动改变编译地址；该变动需要同步sct文件
    ——IMG脚本工具
5、Timer21的每个周期关闭时钟，改为在中断函数后TIMER21_Stop()，不再嵌入DIAG_HSLS_OC_Timer_Handle_ISR函数

/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.6
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.5
软件修改日期 ：2025.03.26
修改人          ： 陆云祺
**************************************************************************/
1、CRC判断逻辑放到if(bol_ComIf_flgCRCFaltRaw == false)上一行；
2、两个通讯故障的策略改成消抖次数都是5次，通讯丢失为2秒，通讯丢失故障放到应用层做；
3、修改在有转速时无法刷写程序，烧写程序增加转速判断；
4、添加通讯标志位，三帧报文只在有请求时更新数据
5、模型修改Chip故障中的变量名字；
6、底层新增1ms任务，将busOBD_SlwTaskIn.bol_flgComLosFaltRaw = Gu8_ComIf_APPRxMesCnt;
 MCUF_RollingCounter_27A = (Gu8_ComIf_APPRxMsgData[6] & (0xF0))>>4;
 busOBD_SlwTaskIn.u8_ctComRolCnt = MCUF_RollingCounter_27A;三个量放置在1ms任务中；
7、修复三相开路故障BUG，通过实验发现，在BDRV初始化完成之后，需要延时100ms,在进行三相开路诊断，这样能够避免由于BDRV模块刚刚配置完成就进行三相开路诊断，从而造成三相开路诊断存在的不稳定问题。
在BDRV初始化完成后，可能会造成三相短路条件的成立，因此，底层中需要增加开管配置完成后，再进行三相短路诊断的判断；
8、取消功能单元PWM_INT_StateHandle，把相关逻辑直接放到PM和OP中断函数中去；变量Su8_PWM_PM_SampleStatus在高频中断中都会置相应的bit位，最后确认没有中断的丢失才采用电流和扇区数据；
9、接口ADC_VSD_VDH_Routine改为被MID_Interface调用，使得接口Interface_500usTask在500us中断中能够被第一个调用；
10、功能单元l_cyclic_com_task从LIN的接收中断改为500us中断中被调用，用以缩减LIN接收中断的时间
11、修改BOOT软件版本号104B，软件版本号003.07
/*************************************************************************
软件新 版本   ：ELOP187_GEELY_9879_120W_V2.8
软件旧 版本   ：ELOP187_GEELY_9879_120W_V2.7
软件修改日期 ：2025.04.08
修改人          ： 林成嘉
**************************************************************************/
1、测试代码屏蔽Mem_EreaseEeprom及其相关的逻辑
2、删除冗余语句ComIf_Set_APPTxMsgData(u8_ComIf_APPTxMsgData2,0x20);
3、OBD模块的输入实际电转速替换成滤波后的电转速，主要涉及堵转、干转、欠速、超速故障
4、通讯新增ComIf_500usTask和 ComDrv_500usTask函数
5、堵转以及软件过流故障中间过程系统状态修改为spin直到确诊才变为falt
